<app-navbar></app-navbar>

<div class="container">
  <div *ngIf="successMessage" class="alert alert-success" role="alert">
    {{ successMessage }}
  </div>
  <div *ngIf="errorMessage" class="alert alert-danger" role="alert">
    {{ errorMessage }}
  </div>

  <!-- Alerta de reservas activas al intentar eliminar -->
  <div *ngIf="reservasBloqueo && reservasBloqueo.length > 0" class="alert alert-bloqueo" role="alert">
    <h5 class="alert-heading fw-bold">
      <i class="fas fa-exclamation-triangle"></i> Reservas activas detectadas
    </h5>
    <p class="mb-3">No puedes eliminar a este cliente porque mantiene reservas activas. Cancela o finaliza las reservas listadas para continuar.</p>
    <div class="list-group">
      <div *ngFor="let reservaBloqueo of reservasBloqueo" class="list-group-item d-flex flex-column flex-lg-row justify-content-between align-items-lg-center mb-2">
        <div>
          <strong class="d-block">Reserva #{{ reservaBloqueo.id }}</strong>
          <span>Habitación: {{ reservaBloqueo.habitacion }}</span><br>
          <span>Desde: {{ reservaBloqueo.fechaInicio | date:'dd/MM/yyyy' }} hasta: {{ reservaBloqueo.fechaFin | date:'dd/MM/yyyy' }}</span><br>
          <span>Estado: {{ reservaBloqueo.estado }}</span>
        </div>
        <div class="mt-3 mt-lg-0">
          <button type="button" class="btn btn-danger btn-sm" (click)="cancelarReserva(reservaBloqueo.id)">
            <i class="fas fa-times-circle"></i> Cancelar
          </button>
          <button *ngIf="reservaBloqueo.estado === 'ACTIVA' || reservaBloqueo.estado === 'PENDIENTE'"
                  type="button" class="btn btn-success btn-sm ms-2"
                  (click)="finalizarReserva(reservaBloqueo.id)">
            <i class="fas fa-check-circle"></i> Finalizar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Vista de detalle del cliente -->
  <div *ngIf="cliente" class="client-details-section">
    <h2 class="mb-4">Detalle del Cliente: {{ cliente.nombres }} {{ cliente.apellidos }}</h2>

    <p><strong>Nombres:</strong> {{ cliente.nombres }}</p>
    <p><strong>Apellidos:</strong> {{ cliente.apellidos }}</p>
    <p><strong>DNI:</strong> {{ cliente.dni }}</p>
    <p><strong>Nacionalidad:</strong> {{ cliente.nacionalidad || 'N/A' }}</p>
    <p><strong>Email:</strong> {{ cliente.email || 'N/A' }}</p>
    <p><strong>Teléfono:</strong> {{ cliente.telefono || 'N/A' }}</p>

    <div class="d-flex align-items-center mb-3">
      <button type="button" class="btn btn-warning me-2" (click)="editarCliente(cliente.id!)">
        <i class="fas fa-edit"></i> Editar Datos del Cliente
      </button>
      <button type="button" class="btn btn-danger" (click)="eliminarCliente(cliente.id!)">
        <i class="fas fa-trash-alt"></i> Eliminar Cliente
      </button>
    </div>

    <hr>
    <h3 class="mt-4">Reservas del Cliente</h3>
    <div *ngIf="reservasCliente.length === 0" class="alert alert-info">
      Este cliente no tiene reservas registradas.
    </div>
    <div *ngIf="reservasCliente.length > 0">
      <table class="table table-striped table-hover">
        <thead>
          <tr>
            <th>ID Reserva</th>
            <th>Habitación</th>
            <th>Fecha Entrada</th>
            <th>Fecha Salida</th>
            <th>Días Estadía</th>
            <th>Total Pagar</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let reserva of reservasCliente">
            <td>{{ reserva.id }}</td>
            <td>{{ reserva.habitacion?.numero }} ({{ reserva.habitacion?.tipo }})</td>
            <td>{{ reserva.fechaInicio | date:'dd-MM-yyyy' }} {{ reserva.horaEntrada }}</td>
            <td>{{ reserva.fechaFin | date:'dd-MM-yyyy' }} {{ reserva.horaSalida }}</td>
            <td>{{ reserva.diasEstadia }}</td>
            <td>
              <span>S/.{{ calcularTotalFinal(reserva) | number:'1.2-2' }}</span>
              <span *ngIf="calcularTotalServicios(reserva) > 0" style="display: block; font-size: 0.85em; color: #87CEEB; margin-top: 2px;">
                (Base: S/.{{ reserva.totalPagar | number:'1.2-2' }} + Servicios: S/.{{ calcularTotalServicios(reserva) | number:'1.2-2' }})
              </span>
            </td>
            <td>
              <span [ngClass]="{
                'badge': true,
                'bg-primary': reserva.estadoReserva === 'ACTIVA',
                'bg-info': reserva.estadoReserva === 'PENDIENTE',
                'bg-success': reserva.estadoReserva === 'FINALIZADA',
                'bg-danger': reserva.estadoReserva === 'CANCELADA'
              }">{{ reserva.estadoReserva }}</span>
            </td>
            <td>
              <div *ngIf="reserva.estadoReserva === 'ACTIVA' || reserva.estadoReserva === 'PENDIENTE'">
                <button *ngIf="!tienePago(reserva)"
                        type="button"
                        class="btn btn-danger btn-sm"
                        (click)="cancelarReserva(reserva.id!)">
                  <i class="fas fa-times-circle"></i> Cancelar
                </button>
                <button type="button"
                        class="btn btn-success btn-sm"
                        [ngClass]="{'ms-2': !tienePago(reserva)}"
                        (click)="finalizarReserva(reserva.id!)">
                  <i class="fas fa-check-circle"></i> Finalizar
                </button>
              </div>
              <div *ngIf="reserva.estadoReserva !== 'ACTIVA' && reserva.estadoReserva !== 'PENDIENTE'">
                <span [ngClass]="{
                  'badge': true,
                  'bg-success': reserva.estadoReserva === 'FINALIZADA',
                  'bg-danger': reserva.estadoReserva === 'CANCELADA'
                }">{{ reserva.estadoReserva }}</span>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <button type="button" class="btn btn-primary mt-3" (click)="volverALista()">
      Volver a la Lista de Clientes
    </button>
  </div>

  <!-- Vista de lista de clientes -->
  <div *ngIf="!cliente" class="client-list-section">
    <h2 class="mb-4">Lista de Clientes Registrados</h2>

    <div class="search-forms-container">
      <form (ngSubmit)="buscar()" class="d-flex flex-grow-1">
        <input type="text"
               [(ngModel)]="searchTerm"
               name="search"
               class="form-control me-2"
               placeholder="Buscar por DNI, Nombres o Apellidos">
        <button type="submit" class="btn btn-primary">Buscar</button>
      </form>

      <form (ngSubmit)="buscarDetallePorDni()" class="d-flex w-auto">
        <input type="text"
               [(ngModel)]="dniSearch"
               name="dni"
               class="form-control me-2"
               placeholder="Buscar detalle por DNI (8 dígitos)"
               style="max-width: 220px;"
               pattern="[0-9]{8}"
               maxlength="8"
               (input)="dniSearch = $any($event.target).value.replace(/[^0-9]/g, '')">
        <button type="submit" class="btn btn-info">Ver Detalle por DNI</button>
      </form>
    </div>

    <hr class="my-4">

    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead>
          <tr>
            <th scope="col">
              <a (click)="ordenar('dni')" class="text-white text-decoration-none" style="cursor: pointer;">
                DNI <i [ngClass]="{
                  'fas': true,
                  'fa-sort': sortBy !== 'dni',
                  'fa-sort-up': sortBy === 'dni' && sortDir === 'asc',
                  'fa-sort-down': sortBy === 'dni' && sortDir === 'desc'
                }"></i>
              </a>
            </th>
            <th scope="col">
              <a (click)="ordenar('nombres')" class="text-white text-decoration-none" style="cursor: pointer;">
                Nombres <i [ngClass]="{
                  'fas': true,
                  'fa-sort': sortBy !== 'nombres',
                  'fa-sort-up': sortBy === 'nombres' && sortDir === 'asc',
                  'fa-sort-down': sortBy === 'nombres' && sortDir === 'desc'
                }"></i>
              </a>
            </th>
            <th scope="col">
              <a (click)="ordenar('apellidos')" class="text-white text-decoration-none" style="cursor: pointer;">
                Apellidos <i [ngClass]="{
                  'fas': true,
                  'fa-sort': sortBy !== 'apellidos',
                  'fa-sort-up': sortBy === 'apellidos' && sortDir === 'asc',
                  'fa-sort-down': sortBy === 'apellidos' && sortDir === 'desc'
                }"></i>
              </a>
            </th>
            <th scope="col">Email</th>
            <th scope="col">Teléfono</th>
            <th scope="col">Reservas Activas</th>
            <th scope="col">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let clienteItem of clientes">
            <td>{{ clienteItem.dni }}</td>
            <td>{{ clienteItem.nombres }}</td>
            <td>{{ clienteItem.apellidos }}</td>
            <td>{{ clienteItem.email || 'N/A' }}</td>
            <td>{{ clienteItem.telefono || 'N/A' }}</td>
            <td>
              <span *ngIf="clienteItem.hasActiveReservations" class="badge bg-success">
                Sí <i class="fas fa-check-circle"></i>
              </span>
              <span *ngIf="!clienteItem.hasActiveReservations" class="badge bg-secondary">
                No <i class="fas fa-times-circle"></i>
              </span>
            </td>
            <td>
              <button type="button" class="btn btn-info btn-sm" (click)="verDetalle(clienteItem.id!)">
                <i class="fas fa-eye"></i> Ver Detalle
              </button>
            </td>
          </tr>
        </tbody>
      </table>
      <div *ngIf="clientes.length === 0" class="no-results">
        <p>No se encontraron clientes.</p>
      </div>
    </div>

    <nav *ngIf="totalPages > 0" aria-label="Page navigation">
      <ul class="pagination pagination-controls">
        <li class="page-item" [ngClass]="{'disabled': currentPage === 0}">
          <a class="page-link" (click)="currentPage > 0 && cambiarPagina(currentPage - 1)" style="cursor: pointer;" aria-label="Previous">
            <span aria-hidden="true">&laquo;</span>
          </a>
        </li>
        <li *ngFor="let page of getPaginasArray()" class="page-item" [ngClass]="{'active': page === currentPage}">
          <a class="page-link" (click)="cambiarPagina(page)" style="cursor: pointer;">{{ page + 1 }}</a>
        </li>
        <li class="page-item" [ngClass]="{'disabled': currentPage === totalPages - 1}">
          <a class="page-link" (click)="currentPage < totalPages - 1 && cambiarPagina(currentPage + 1)" style="cursor: pointer;" aria-label="Next">
            <span aria-hidden="true">&raquo;</span>
          </a>
        </li>
      </ul>
    </nav>
  </div>
</div>
