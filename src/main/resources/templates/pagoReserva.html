<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pago de Reserva - Oasis Digital</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --azul-oasis: #4A90E2;
            --azul-claro: #87CEEB;
            --azul-cielo: #B0E0E6;
            --azul-profundo: #1E3A8A;
            --azul-royal: #4169E1;
            --blanco: #ffffff;
            --gris-claro: #F8FAFC;
            --gris-medio: #E2E8F0;
            --gris-oscuro: #334155;
            --negro: #1a1a1a;
            --negro-suave: #2d2d2d;
            --negro-carbon: #0f0f0f;
            --negro-profundo: #000000;
            --negro-elegante: #1c1c1c;
            --negro-metalico: #2c2c2c;
            --dorado-elegante: #F59E0B;
            --sombra-azul: rgba(74, 144, 226, 0.3);
            --sombra-negra: rgba(0, 0, 0, 0.4);
            --sombra-negra-intensa: rgba(0, 0, 0, 0.7);
        }
        
        body {
            background: linear-gradient(135deg, var(--negro-carbon) 0%, var(--negro) 30%, var(--gris-oscuro) 70%, #F0F8FF 100%);
            color: var(--blanco);
            min-height: 100vh;
            font-family: 'Inter', sans-serif;
        }
        
        .form-label {
            color: var(--blanco) !important;
            font-weight: 600 !important;
        }
        
        .form-check-label {
            color: var(--blanco) !important;
        }
        
        /* FORZAR TODOS LOS TEXTOS A BLANCO */
        .card-body p, .card-body span, .card-body strong, .card-body h5, .card-body h6 {
            color: var(--blanco) !important;
        }
        
        .form-control::placeholder {
            color: rgba(255, 255, 255, 0.6) !important;
        }
        
        .text-muted {
            color: rgba(255, 255, 255, 0.7) !important;
        }
        
        .list-group-item {
            background: linear-gradient(145deg, var(--negro-suave) 0%, var(--negro) 100%) !important;
            border: 1px solid var(--azul-oasis) !important;
            color: var(--blanco) !important;
        }
        
        .alert-success {
            background-color: #28a745 !important;
            border-color: #28a745 !important;
            color: #ffffff !important;
        }
        
        .alert-danger {
            background-color: #dc3545 !important;
            border-color: #dc3545 !important;
            color: #ffffff !important;
        }

        .navbar {
            background: linear-gradient(90deg, var(--negro) 0%, var(--negro-suave) 100%) !important;
            border-bottom: 3px solid var(--azul-oasis);
            box-shadow: 0 4px 20px var(--sombra-negra), 0 0 15px var(--sombra-azul);
            backdrop-filter: blur(10px);
        }

        .navbar-brand {
            color: #ffffff !important;
            font-weight: bold;
        }

        .card {
            background: linear-gradient(145deg, var(--negro-suave) 0%, var(--negro) 50%, var(--gris-oscuro) 100%);
            border: 2px solid var(--azul-oasis);
            border-radius: 20px;
            box-shadow: 0 15px 40px var(--sombra-negra), 0 0 20px rgba(74, 144, 226, 0.3);
            backdrop-filter: blur(15px);
        }

        .card-header {
            background: linear-gradient(135deg, #4A90E2 0%, #4169E1 100%);
            color: #ffffff;
            font-weight: bold;
            border-radius: 13px 13px 0 0 !important;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4A90E2 0%, #4169E1 100%);
            border-color: #4A90E2;
            color: #ffffff;
            font-weight: bold;
            border-radius: 25px;
            box-shadow: 0 8px 25px rgba(74, 144, 226, 0.3);
        }

        .btn-outline-light {
            border: 2px solid #4A90E2;
            color: #4A90E2;
            border-radius: 25px;
        }

        .btn-outline-light:hover {
            background-color: #4A90E2;
            color: #ffffff;
        }

        .form-control {
            background: linear-gradient(145deg, var(--negro-suave) 0%, var(--negro) 100%);
            border: 2px solid var(--azul-oasis);
            color: var(--blanco);
            border-radius: 12px;
            padding: 12px 15px;
            transition: all 0.3s ease;
            box-shadow: inset 0 2px 5px var(--sombra-negra);
        }

        .form-control:focus {
            box-shadow: 0 0 0 0.25rem rgba(74, 144, 226, 0.25);
            border-color: #4A90E2;
        }

        .badge-custom {
            background: linear-gradient(135deg, #4A90E2 0%, #4169E1 100%);
            color: #ffffff;
        }
    </style>
</head>

<body>

    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/dashboard">Oasis Digital</a>
        </div>
    </nav>

    <div class="container py-4">
        <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>
        <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>

        <div class="row g-4">
            <div class="col-lg-5 order-lg-2">
                <div class="card">
                    <div class="card-header">
                        Resumen de Pago
                    </div>
                    <div class="card-body">
                        <h5 th:text="'Reserva #' + ${reserva.id}"></h5>
                        <p class="mb-1"><strong>Cliente:</strong> <span th:text="${reserva.cliente.nombres + ' ' + reserva.cliente.apellidos}"></span></p>
                        <p class="mb-1"><strong>Habitación:</strong> <span th:text="${reserva.habitacion.numero + ' - ' + reserva.habitacion.tipo}"></span></p>
                        <p class="mb-1"><strong>Estadía:</strong>
                            <span th:text="${#temporals.format(reserva.fechaInicio, 'dd/MM/yyyy')}"></span>
                            -
                            <span th:text="${#temporals.format(reserva.fechaFin, 'dd/MM/yyyy')}"></span>
                        </p>
                        <hr>
                        <p><strong>Subtotal habitación:</strong> <span th:text="${'S/ ' + #numbers.formatDecimal(montoBase, 1, 'POINT', 2, 'COMMA')}"></span></p>
                        <p><strong>Servicios adicionales:</strong>
                            <span th:text="${'S/ ' + #numbers.formatDecimal(montoServicios, 1, 'POINT', 2, 'COMMA')}"></span>
                        </p>
                        <h4 class="mt-3"><strong>Total:</strong> <span class="badge badge-custom" th:text="${'S/ ' + #numbers.formatDecimal(montoTotal, 1, 'POINT', 2, 'COMMA')}"></span></h4>

                        <div th:if="${reserva.servicios != null and !reserva.servicios.isEmpty()}">
                            <h6 class="mt-4">Servicios incluidos:</h6>
                            <ul class="list-group list-group-numbered">
                                <li class="list-group-item" th:each="servicio : ${reserva.servicios}">
                                    <span th:text="${servicio.nombre}"></span>
                                    <span class="float-end" th:text="${'S/ ' + #numbers.formatDecimal(servicio.precio, 1, 'POINT', 2, 'COMMA')}"></span>
                                </li>
                            </ul>
                        </div>
                        <div th:if="${pagoProcesado != null}" class="alert alert-success mt-4">
                            <strong>Pago aprobado.</strong> Referencia: <span th:text="${pagoProcesado.referencia}"></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-7 order-lg-1">
                <div class="card">
                    <div class="card-header">
                        Datos de pago
                    </div>
                    <div class="card-body">
                        <form th:action="@{/reservas/{id}/pago(id=${reserva.id})}" method="post" id="formPago">
                            <input type="hidden" name="returnTo" th:value="${returnTo}">
                            <div class="mb-3">
                                <label class="form-label">Método de pago</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="metodo" id="metodoTarjeta" value="TARJETA" checked>
                                    <label class="form-check-label" for="metodoTarjeta">
                                        Tarjeta de crédito / débito
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="metodo" id="metodoYape" value="YAPE">
                                    <label class="form-check-label" for="metodoYape">
                                        Yape
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="metodo" id="metodoPlin" value="PLIN">
                                    <label class="form-check-label" for="metodoPlin">
                                        Plin
                                    </label>
                                </div>
                            </div>

                            <div id="tarjetaFields">
                                <div class="mb-3">
                                    <label class="form-label">Número de tarjeta</label>
                                    <div class="row g-2">
                                        <div class="col-3">
                                            <input type="text" class="form-control text-center" id="card1" maxlength="4" placeholder="0000" required>
                                        </div>
                                        <div class="col-3">
                                            <input type="text" class="form-control text-center" id="card2" maxlength="4" placeholder="0000" required>
                                        </div>
                                        <div class="col-3">
                                            <input type="text" class="form-control text-center" id="card3" maxlength="4" placeholder="0000" required>
                                        </div>
                                        <div class="col-3">
                                            <input type="text" class="form-control text-center" id="card4" maxlength="4" placeholder="0000" required>
                                        </div>
                                    </div>
                                    <input type="hidden" id="numeroTarjeta" name="numeroTarjeta">
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="fechaExp" class="form-label">Fecha de expiración (MM/AA)</label>
                                        <input type="text" class="form-control" id="fechaExp" name="fechaExp" placeholder="08/28" maxlength="5" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="cvv" class="form-label">CVV</label>
                                        <input type="password" class="form-control" id="cvv" name="cvv" placeholder="123" maxlength="3" required>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="titularTarjeta" class="form-label">Titular</label>
                                    <input type="text" class="form-control" id="titularTarjeta" name="titularTarjeta" placeholder="Nombre como figura en la tarjeta" required>
                                </div>
                            </div>

                            <div id="walletFields" class="d-none">
                                <div class="mb-3">
                                    <label for="telefonoWallet" class="form-label">Número asociado</label>
                                    <input type="text" class="form-control" id="telefonoWallet" name="telefonoWallet" placeholder="987654321" maxlength="9">
                                </div>
                                <div class="mb-3">
                                    <label for="titularWallet" class="form-label">Titular de la cuenta</label>
                                    <input type="text" class="form-control" id="titularWallet" name="titularWallet" placeholder="Nombre completo">
                                </div>
                                <p class="text-muted fst-italic">Te mostraremos un QR o enviamos la solicitud al número registrado para confirmar el pago en tu app.</p>
                            </div>

                            <button type="submit" class="btn btn-primary w-100 mt-3">Procesar pago</button>
                        </form>
                    </div>
                </div>
                <a th:href="@{/reservas/{id}/servicios(id=${reserva.id})}" class="btn btn-outline-light mt-3">
                    Volver a servicios
                </a>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const metodoRadios = document.querySelectorAll('input[name="metodo"]');
            const tarjetaFields = document.getElementById('tarjetaFields');
            const walletFields = document.getElementById('walletFields');
            const tarjetaInputs = tarjetaFields.querySelectorAll('input:not([type="hidden"])');
            const walletInputs = walletFields.querySelectorAll('input');

            // Formateo de número de tarjeta
            const cardInputs = [document.getElementById('card1'), document.getElementById('card2'), 
                               document.getElementById('card3'), document.getElementById('card4')];
            const numeroTarjetaHidden = document.getElementById('numeroTarjeta');

            cardInputs.forEach((input, index) => {
                input.addEventListener('input', function(e) {
                    // Solo permitir números
                    this.value = this.value.replace(/\D/g, '');
                    
                    // Actualizar campo oculto
                    updateCardNumber();
                    
                    // Auto-focus al siguiente campo cuando se completa
                    if (this.value.length === 4 && index < cardInputs.length - 1) {
                        cardInputs[index + 1].focus();
                    }
                });
                
                input.addEventListener('keydown', function(e) {
                    // Permitir backspace para ir al campo anterior
                    if (e.key === 'Backspace' && this.value.length === 0 && index > 0) {
                        cardInputs[index - 1].focus();
                    }
                });
            });

            function updateCardNumber() {
                const cardNumber = cardInputs.map(input => input.value).join('');
                numeroTarjetaHidden.value = cardNumber;
            }

            // Formateo de fecha de vencimiento
            document.getElementById('fechaExp').addEventListener('input', function(e) {
                let value = this.value.replace(/\D/g, '');
                if (value.length >= 2) {
                    value = value.substring(0, 2) + '/' + value.substring(2, 4);
                }
                this.value = value;
            });

            // Solo números en CVV
            document.getElementById('cvv').addEventListener('input', function(e) {
                this.value = this.value.replace(/\D/g, '');
            });

            // Formateo de teléfono (máximo 9 dígitos)
            document.getElementById('telefonoWallet').addEventListener('input', function(e) {
                this.value = this.value.replace(/\D/g, '').substring(0, 9);
            });

            const toggleFields = (metodo) => {
                if (metodo === 'TARJETA') {
                    tarjetaFields.classList.remove('d-none');
                    walletFields.classList.add('d-none');
                    tarjetaInputs.forEach(input => input.required = true);
                    walletInputs.forEach(input => input.required = false);
                } else {
                    tarjetaFields.classList.add('d-none');
                    walletFields.classList.remove('d-none');
                    tarjetaInputs.forEach(input => input.required = false);
                    walletInputs.forEach(input => input.required = true);
                }
            };

            metodoRadios.forEach(radio => {
                radio.addEventListener('change', (event) => {
                    toggleFields(event.target.value);
                });
            });

            toggleFields(document.querySelector('input[name="metodo"]:checked').value);
        });
    </script>
</body>

</html>

